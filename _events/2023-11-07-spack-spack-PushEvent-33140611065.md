---
event_type: PushEvent
avatar: "https://avatars.githubusercontent.com/u/299842?"
user: tgamblin
date: 2023-11-07
repo_name: spack/spack
html_url: https://github.com/spack/spack/commit/910190f55bb5467305dd75a4dac8c60f1f51e283
repo_url: https://github.com/spack/spack
---

<a href='https://github.com/tgamblin' target='_blank'>tgamblin</a> pushed to <a href='https://github.com/spack/spack' target='_blank'>spack/spack</a>

<small>database: optimize query() by skipping unnecessary virtual checks (#40898)

Most queries will end up calling `spec.satisfies(query)` on everything in the DB, which
will cause Spack to ask whether the query spec is virtual if its name doesn't match the
target spec's. This can be expensive, because it can cause Spack to check if any new
virtuals showed up in *all* the packages it knows about. That can currently trigger
thousands of `stat()` calls.

We can avoid the virtual check for most successful queries if we consider that if there
*is* a match by name, the query spec *can't* be virtual. This PR adds an optimization to
the query loop to save any comparisons that would trigger a virtual check for last.

- [x] Add a `deferred` list to the `query()` loop.
- [x] First run through the `query()` loop *only* checks for name matches.
- [x] Query loop now returns early if there's a name match, skipping most `satisfies()` calls.
- [x] Second run through the `deferred()` list only runs if query spec is virtual.
- [x] Fix up handling of concrete specs.
- [x] Add test for querying virtuals in DB.
- [x] Avoid allocating deferred if not necessary.

---------

Co-authored-by: Harmen Stoppels <me@harmenstoppels.nl></small>

<a href='https://github.com/spack/spack/commit/910190f55bb5467305dd75a4dac8c60f1f51e283' target='_blank'>View Commit</a>