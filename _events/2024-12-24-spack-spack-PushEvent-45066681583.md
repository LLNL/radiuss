---
event_type: PushEvent
avatar: "https://avatars.githubusercontent.com/u/4199709?"
user: alalazo
date: 2024-12-24
repo_name: spack/spack
html_url: https://github.com/spack/spack/commit/e9cdcc4af02002f870955f9b1b12422b81f27c05
repo_url: https://github.com/spack/spack
---

<a href='https://github.com/alalazo' target='_blank'>alalazo</a> pushed to <a href='https://github.com/spack/spack' target='_blank'>spack/spack</a>

<small>build caches: collect files to relocate while tarballing w/o file (#48212)

A few changes to tarball creation (for build caches):
- do not run file to distinguish binary from text
- file is slow, even when running it in a batched fashion -- it usually reads all bytes and has slow logic to categorize specific types
- we don't need a highly detailed file categorization; a crude categorization of elf, mach-o, text suffices.
detecting elf and mach-o is straightforward and cheap
- detecting utf-8 (and with that ascii) is highly accurate: false positive rate decays exponentially as file size increases. Further it's not only the most common encoding, but the most common file type in package prefixes.
iso-8859-1 is cheaply (but heuristically) detected too, and sufficiently accurate after binaries and utf-8 files are classified earlier
- remove file as a dependency of Spack in general, which makes Spack itself easier to install
- detect file type and need to relocate as part of creating the tarball, which is more cache friendly and thus faster</small>

<a href='https://github.com/spack/spack/commit/e9cdcc4af02002f870955f9b1b12422b81f27c05' target='_blank'>View Commit</a>