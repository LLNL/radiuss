---
event_type: PushEvent
avatar: "https://avatars.githubusercontent.com/u/299842?"
user: tgamblin
date: 2024-09-17
repo_name: spack/spack
html_url: https://github.com/spack/spack/commit/930e71177144c7f7c1b7ff6013a298db8a5eafad
repo_url: https://github.com/spack/spack
---

<a href='https://github.com/tgamblin' target='_blank'>tgamblin</a> pushed to <a href='https://github.com/spack/spack' target='_blank'>spack/spack</a>

<small>coverage: only upload to codecov once (#46385)

Historically, every PR, push, etc. to Spack generates a bunch of jobs, each of which
uploads its coverage report to codecov independently. This means that we get annoying
partial coverage numbers when only a few of the jobs have finished, and frequently
codecov is bad at understanding when to merge reports for a given PR. The numbers of the
site can be weird as a result.

This restructures our coverage handling so that we do all the merging ourselves and
upload exactly one report per GitHub actions workflow. In practice, that means that
every push to every PR will get exactly one coverage report and exactly one coverage
number reported. I think this will at least partially restore peoples' faith in what
codecov is telling them, and it might even make codecov handle Spack a bit better, since
this reduces the report burden by ~7x.

- [x] test and audit jobs now upload artifacts for coverage
- [x] add a new job that downloads artifacts and merges coverage reports together
- [x] set `paths` section of `pyproject.toml` so that cross-platform clone locations are merged
- [x] upload to codecov once, at the end of the workflow

Signed-off-by: Todd Gamblin <tgamblin@llnl.gov></small>

<a href='https://github.com/spack/spack/commit/930e71177144c7f7c1b7ff6013a298db8a5eafad' target='_blank'>View Commit</a>